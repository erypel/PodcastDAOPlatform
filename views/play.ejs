<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Play</title>
</head>
<body>
	<script src="https://unpkg.com/wavesurfer.js"></script>
	<section id="content">
		<div id="waveform"></div>
		<p align="center">
			<button class="btn btn-primary" onclick="wavesurfer.playPause()">
				<i class="glyphicon glyphicon-play"></i> Play
			</button>
		</p>
	</section>
	<br>
	<section id="discussion">
		<h3>Discussion Section</h3>
		<form action="/comment" method="post" id="postCommentForm">
			<input type="text" name="comment" placeholder="Add to the discussion..." required />
			<input type="hidden" name="podcastID" value="<%=podcastID%>"/>
			<input type="submit" value="Add comment" />
		</form>
		<div id="comments">
			<table border="1">
			<tr>
				<th>User</th><th>Comment</th><th>Reply</th><th>Tip</th>
			</tr>
			<% comments.forEach(function(comment) { %>
				<tr>
					<td><%=comment.commenter%></td>
					<td><%=comment.message%></td>
					<td><a href=""><button>Reply</button></a></td>
					<td>
						<form action="" method = "post">
          					<button>Tip 1 XRP</button>
    					</form>
    				</td>
				</tr>
			<% }) %>
		</table>
		</div>
	</section>
	<br>
	<section id="footer">
		<form action="/podcast" method="get">
			<button>Back</button>
		</form>
		<form action="/logout" method="get">
			<button>Logout</button>
		</form>
	</section>

	<script type="text/javascript">
		//TODO this script should go in its own file
		// taken from authentication. need to refactor
		function post(path, data) {
			return window.fetch(path, {
				method : 'POST',
				headers : {
					'Accept' : 'application/json',
					'Content-Type' : 'application/json'
				},
				body : JSON.stringify(data)
			})
		}

		let wavesurfer = WaveSurfer.create({
			container : '#waveform',
			waveColor : 'violet',
			progressColor : 'purple'
		})
		let a = "<%=adPath%>"
		let p = "<%=epPath%>"
		let autoPlay = true
		//need to run `http-server --cors` for access to file server
		//if there's a linked ad
		if (a != null) {
			console.log(a)
			wavesurfer.load("uploads/" + a)
			wavesurfer.on('ready', function() {
				wavesurfer.play();
			})
			let playNext = true
			wavesurfer.on('finish', function() {
				if (playNext) {
					post('/payAuthor', {
						campaignID : '<%=campaignID%>',
						adID : '<%=adID %>',
						podcastID : '<%=podcastID %>'
					})
					wavesurfer.load("uploads/" + p)
					playNext = false;
				}
			})
		}
		//if there is no linked ad
		else {
			wavesurfer.load("uploads/" + p)
			wavesurfer.on('ready', function() {
				wavesurfer.play();
			})
		}
	</script>
</body>
</html>